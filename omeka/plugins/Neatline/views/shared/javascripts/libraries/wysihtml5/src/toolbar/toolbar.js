(function(g){var e=g.dom;g.toolbar.Toolbar=Base.extend({constructor:function(b,c){this.editor=b;this.container=typeof c==="string"?document.getElementById(c):c;this.composer=b.composer;this._getLinks("command");this._getLinks("action");this._observe();this.show();for(var d=this.container.querySelectorAll("[data-wysihtml5-command=insertSpeech]"),f=d.length,a=0;a<f;a++)new g.toolbar.Speech(this,d[a])},_getLinks:function(b){for(var c=this[b+"Links"]=g.lang.array(this.container.querySelectorAll("[data-wysihtml5-"+
b+"]")).get(),d=c.length,f=0,a=this[b+"Mapping"]={},e,j,h,i,k;f<d;f++)e=c[f],h=e.getAttribute("data-wysihtml5-"+b),i=e.getAttribute("data-wysihtml5-"+b+"-value"),j=this.container.querySelector("[data-wysihtml5-"+b+"-group='"+h+"']"),k=this._getDialog(e,h),a[h+":"+i]={link:e,group:j,name:h,value:i,dialog:k,state:!1}},_getDialog:function(b,c){var d=this,f=this.container.querySelector("[data-wysihtml5-dialog='"+c+"']"),a,e;f&&(a=new g.toolbar.Dialog(b,f),a.observe("show",function(){e=d.composer.selection.getBookmark();
d.editor.fire("show:dialog",{command:c,dialogContainer:f,commandLink:b})}),a.observe("save",function(a){e&&d.composer.selection.setBookmark(e);d._execCommand(c,a);d.editor.fire("save:dialog",{command:c,dialogContainer:f,commandLink:b})}),a.observe("cancel",function(){d.editor.focus(!1);d.editor.fire("cancel:dialog",{command:c,dialogContainer:f,commandLink:b})}));return a},execCommand:function(b,c){if(!this.commandsDisabled){var d=this.commandMapping[b+":"+c];d&&d.dialog&&!d.state?d.dialog.show():
this._execCommand(b,c)}},_execCommand:function(b,c){this.editor.focus(!1);this.composer.commands.exec(b,c);this._updateLinkStates()},execAction:function(b){var c=this.editor;switch(b){case "change_view":c.currentView===c.textarea?c.fire("change_view","composer"):c.fire("change_view","textarea")}},_observe:function(){for(var b=this,c=this.editor,d=this.container,f=this.commandLinks.concat(this.actionLinks),a=f.length,g=0;g<a;g++)e.setAttributes({href:"javascript:;",unselectable:"on"}).on(f[g]);e.delegate(d,
"[data-wysihtml5-command]","mousedown",function(b){b.preventDefault()});e.delegate(d,"[data-wysihtml5-command]","click",function(a){var c=this.getAttribute("data-wysihtml5-command"),d=this.getAttribute("data-wysihtml5-command-value");b.execCommand(c,d);a.preventDefault()});e.delegate(d,"[data-wysihtml5-action]","click",function(a){var c=this.getAttribute("data-wysihtml5-action");b.execAction(c);a.preventDefault()});c.observe("focus:composer",function(){b.bookmark=null;clearInterval(b.interval);b.interval=
setInterval(function(){b._updateLinkStates()},500)});c.observe("blur:composer",function(){clearInterval(b.interval)});c.observe("destroy:composer",function(){clearInterval(b.interval)});c.observe("change_view",function(a){setTimeout(function(){b.commandsDisabled=a!=="composer";b._updateLinkStates();b.commandsDisabled?e.addClass(d,"wysihtml5-commands-disabled"):e.removeClass(d,"wysihtml5-commands-disabled")},0)})},_updateLinkStates:function(){var b=this.commandMapping,c=this.actionMapping,d,f,a;for(d in b)if(a=
b[d],this.commandsDisabled?(f=!1,e.removeClass(a.link,"wysihtml5-command-active"),a.group&&e.removeClass(a.group,"wysihtml5-command-active"),a.dialog&&a.dialog.hide()):(f=this.composer.commands.state(a.name,a.value),g.lang.object(f).isArray()&&(f=f.length===1?f[0]:!0),e.removeClass(a.link,"wysihtml5-command-disabled"),a.group&&e.removeClass(a.group,"wysihtml5-command-disabled")),a.state!==f)(a.state=f)?(e.addClass(a.link,"wysihtml5-command-active"),a.group&&e.addClass(a.group,"wysihtml5-command-active"),
a.dialog&&(typeof f==="object"?a.dialog.show(f):a.dialog.hide())):(e.removeClass(a.link,"wysihtml5-command-active"),a.group&&e.removeClass(a.group,"wysihtml5-command-active"),a.dialog&&a.dialog.hide());for(d in c)if(b=c[d],b.name==="change_view")b.state=this.editor.currentView===this.editor.textarea,b.state?e.addClass(b.link,"wysihtml5-action-active"):e.removeClass(b.link,"wysihtml5-action-active")},show:function(){this.container.style.display=""},hide:function(){this.container.style.display="none"}})})(wysihtml5);
