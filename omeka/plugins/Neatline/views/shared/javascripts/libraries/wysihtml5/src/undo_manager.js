(function(d){var j='<span id="_wysihtml5-undo" class="_wysihtml5-temp">'+d.INVISIBLE_SPACE+"</span>",k='<span id="_wysihtml5-redo" class="_wysihtml5-temp">'+d.INVISIBLE_SPACE+"</span>",e=d.dom;d.UndoManager=d.lang.Dispatcher.extend({constructor:function(b){this.editor=b;this.composer=b.composer;this.element=this.composer.element;this.history=[this.composer.getValue()];this.position=1;this.composer.commands.support("insertHTML")&&this._observe()},_observe:function(){var b=this,c=this.composer.sandbox.getDocument(),
g;e.observe(this.element,"keydown",function(a){if(!(a.altKey||!a.ctrlKey&&!a.metaKey)){var c=a.keyCode,d=c===90&&a.shiftKey||c===89;c===90&&!a.shiftKey?(b.undo(),a.preventDefault()):d&&(b.redo(),a.preventDefault())}});e.observe(this.element,"keydown",function(a){a=a.keyCode;a!==g&&(g=a,(a===8||a===46)&&b.transact())});if(d.browser.hasUndoInContextMenu()){var h,i,f=function(){for(var a;a=c.querySelector("._wysihtml5-temp");)a.parentNode.removeChild(a);clearInterval(h)};e.observe(this.element,"contextmenu",
function(){f();b.composer.selection.executeAndRestoreSimple(function(){b.element.lastChild&&b.composer.selection.setAfter(b.element.lastChild);c.execCommand("insertHTML",!1,j);c.execCommand("insertHTML",!1,k);c.execCommand("undo",!1,null)});h=setInterval(function(){c.getElementById("_wysihtml5-redo")?(f(),b.redo()):c.getElementById("_wysihtml5-undo")||(f(),b.undo())},400);i||(i=!0,e.observe(document,"mousedown",f),e.observe(c,["mousedown","paste","cut","copy"],f))})}this.editor.observe("newword:composer",
function(){b.transact()}).observe("beforecommand:composer",function(){b.transact()})},transact:function(){var b=this.history[this.position-1],c=this.composer.getValue();if(c!=b){if((this.history.length=this.position)>40)this.history.shift(),this.position--;this.position++;this.history.push(c)}},undo:function(){this.transact();this.position<=1||(this.set(this.history[--this.position-1]),this.editor.fire("undo:composer"))},redo:function(){this.position>=this.history.length||(this.set(this.history[++this.position-
1]),this.editor.fire("redo:composer"))},set:function(b){this.composer.setValue(b);this.editor.focus(!0)}})})(wysihtml5);
